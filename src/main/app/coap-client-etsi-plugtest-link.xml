<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:coap-client="http://www.mulesoft.org/schema/mule/coap-client" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:validation="http://www.mulesoft.org/schema/mule/validation" 
	xmlns="http://www.mulesoft.org/schema/mule/core" 
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/coap-client http://www.teslanet.nl/schema/mule/coap-client/1.0/mule-coap-client.xsd">
	
	<sub-flow name="coap-client-etsi-plugtest-TD_COAP_LINK_01">
		<set-payload value="#[ NullPayload.getInstance() ]" doc:name="Set Payload" encoding="UTF-8" mimeType="text/plain"/>
		<set-variable variableName="found_link1" value="#[ false ]" doc:name="reset found_link1"/>
		<set-variable variableName="found_link2" value="#[ false ]" doc:name="reset found_link2"/>
		<set-variable variableName="found_link3" value="#[ false ]" doc:name="reset found_link3"/>

		<coap-client:discover config-ref="ETSI-Plugtest_Client" port="#[flowVars.port]" doc:name="CoAP Discover" host="#[flowVars.host]"/>
		<logger level="INFO" doc:name="Logger"/>
		<validation:is-not-empty config-ref="Validation_Configuration" message="Failed to discover"  doc:name="Validation success" value="#[payload]"/>
		<enricher doc:name="Message Enricher"  >
			<foreach collection="#[payload]" doc:name="For Each">
			    <choice doc:name="Choice">
			        <when expression="#[payload.getURI() == '/link1']">
			            <set-variable variableName="found_link1" value="#[ true ]" doc:name="found_link1"/>
			        </when>
			        <when expression="#[payload.getURI() == '/link2']">
			            <set-variable variableName="found_link2" value="#[ true ]" doc:name="found_link2"/>
			        </when>
			        <when expression="#[payload.getURI() == '/link3']">
			            <set-variable variableName="found_link3" value="#[ true ]" doc:name="found_link3"/>
			        </when>
			        <otherwise>
			            <echo-component doc:name="Echo"/>
			        </otherwise>
			    </choice>
			</foreach>
			<enrich source="#[flowVars.found_link1]" target="#[flowVars.found_link1]"/>
			<enrich source="#[flowVars.found_link2]" target="#[flowVars.found_link2]"/>
			<enrich source="#[flowVars.found_link3]" target="#[flowVars.found_link3]"/>
		</enricher>
		<validation:is-true config-ref="Validation_Configuration" 
			message="CoAP /link1 resource should be found." 
			 doc:name="Validation existence /link1 resource" expression="#[flowVars.found_link1 == true]"/>
		<validation:is-true config-ref="Validation_Configuration" 
			message="CoAP /link2 resource should be found." 
			 doc:name="Validation existence /link2 resource" expression="#[flowVars.found_link2 == true]"/>
		<validation:is-true config-ref="Validation_Configuration" 
			message="CoAP link3 resource should be found." 
			 doc:name="Validation existence /link3 resource" expression="#[flowVars.found_link3 == true]"/>
		<object-to-string-transformer doc:name="Object to String"/>
        <set-payload value="Test OK: #[payload]" doc:name="Set Payload"/>
		<logger message="#[payload]" level="INFO" doc:name="Logger"/>
       
	</sub-flow>
	
	<sub-flow name="coap-client-etsi-plugtest-TD_COAP_LINK_02">
		<set-payload value="#[ NullPayload.getInstance() ]" doc:name="Set Payload" encoding="UTF-8" mimeType="text/plain"/>
		<set-variable variableName="found_link1" value="#[ false ]" doc:name="reset found_link1"/>
		<set-variable variableName="found_link2" value="#[ false ]" doc:name="reset found_link2"/>
		<set-variable variableName="found_link3" value="#[ false ]" doc:name="reset found_link3"/>

		<coap-client:discover config-ref="ETSI-Plugtest_Client" port="#[flowVars.port]" doc:name="CoAP Discover" host="#[flowVars.host]">
            <coap-client:query-parameters>
                <coap-client:query-parameter>rt=Type1</coap-client:query-parameter>
            </coap-client:query-parameters>
        </coap-client:discover>
		<logger level="INFO" doc:name="Logger"/>
		<validation:is-not-empty config-ref="Validation_Configuration" message="Failed to discover"  doc:name="Validation success" value="#[payload]"/>
		<enricher doc:name="Message Enricher"  >
			<foreach collection="#[payload]" doc:name="For Each">
			    <choice doc:name="Choice">
			        <when expression="#[payload.getURI() == '/link1']">
			            <set-variable variableName="found_link1" value="#[ true ]" doc:name="found_link1"/>
			        </when>
			        <when expression="#[payload.getURI() == '/link2']">
			            <set-variable variableName="found_link2" value="#[ true ]" doc:name="found_link2"/>
			        </when>
			        <when expression="#[payload.getURI() == '/link3']">
			            <set-variable variableName="found_link3" value="#[ true ]" doc:name="found_link3"/>
			        </when>
			        <otherwise>
			            <echo-component doc:name="Echo"/>
			        </otherwise>
			    </choice>
			</foreach>
			<enrich source="#[flowVars.found_link1]" target="#[flowVars.found_link1]"/>
			<enrich source="#[flowVars.found_link2]" target="#[flowVars.found_link2]"/>
			<enrich source="#[flowVars.found_link3]" target="#[flowVars.found_link3]"/>
		</enricher>
		<validation:is-true config-ref="Validation_Configuration" 
			message="CoAP /link1 resource should be found." 
			 doc:name="Validation existence /link1 resource" expression="#[flowVars.found_link1 == true]"/>
		<validation:is-false config-ref="Validation_Configuration" 
			message="CoAP /link2 resource should be found." 
			 doc:name="Validation existence /link2 resource" expression="#[flowVars.found_link2 == true]"/>
		<validation:is-true config-ref="Validation_Configuration" 
			message="CoAP link3 resource should not be found." 
			 doc:name="Validation existence /link3 resource" expression="#[flowVars.found_link3 == true]"/>
		<object-to-string-transformer doc:name="Object to String"/>
        <set-payload value="Test OK: #[payload]" doc:name="Set Payload"/>
		<logger message="#[payload]" level="INFO" doc:name="Logger"/>
      
	</sub-flow>
		
</mule>
