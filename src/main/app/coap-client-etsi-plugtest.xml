<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:coap-client="http://www.mulesoft.org/schema/mule/coap-client" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/coap-client http://www.teslanet.nl/schema/mule/coap-client/1.0/mule-coap-client.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
    <coap-client:config name="ETSI-Plugtest_Client" host="127.0.0.1" port="5683" doc:name="CoAP Client: Configuration"/>
    <validation:config name="Validation_Configuration" doc:name="Validation Configuration"/>
    
    <choice-exception-strategy name="client-exception-strategy" >
        <catch-exception-strategy doc:name="Catch Validation Exception" when="#[exception.causedBy(org.mule.extension.validation.api.ValidationException)]">
            <set-property propertyName="http.status" value="502" doc:name="set http.status 502"/>
            <set-payload value="#[exception.getMessage()]" encoding="UTF-8" mimeType="text/plain" doc:name="Set validation message"/>
        </catch-exception-strategy>
        <rollback-exception-strategy doc:name="Rollback Exception Strategy">
            <logger level="INFO" doc:name="Logger" message="Unknown error"/>
        </rollback-exception-strategy>
    </choice-exception-strategy>
    
    <sub-flow name="coap-client-etsi-plugtest-set-params">
        <choice doc:name="set host if present">
            <when expression="#[ message.inboundProperties.'http.query.params'.host != empty ]">
                <set-variable variableName="host" value="#[ message.inboundProperties.'http.query.params'.host ]" doc:name="set host"/>
            </when>
            <otherwise>
                <set-variable variableName="host" value="127.0.0.1" doc:name="set localhost"/>
            </otherwise>
        </choice>
                <choice doc:name="set port if present">
            <when expression="#[ message.inboundProperties.'http.query.params'.port != empty ]">
                <set-variable variableName="port" value="#[ message.inboundProperties.'http.query.params'.port ]" doc:name="set port"/>
            </when>
            <otherwise>
                <set-variable variableName="port" value="5683" doc:name="set port"/>
            </otherwise>
        </choice>
    </sub-flow>
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_01_10">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Get /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.opt.content_format"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <set-payload value="Test OK: #[payload]
" doc:name="Set Payload"/>
        
    </sub-flow >
    
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_02">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:delete config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Delete /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.02']" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >

    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_03">
        <set-payload value="Client request content" doc:name="Set Payload"  />
        <set-property propertyName="coap.opt.content_format" value="0" doc:name="Property"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:put config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Put /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CREATED or CHANGED" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.01' || message.inboundProperties.'coap.response.code' == '2.04' ]" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
        
     
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_04">
        <set-payload value="Client request content" doc:name="Set Payload"  />
        <set-property propertyName="coap.opt.content_format" value="0" doc:name="Property"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:post config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Put /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CREATED or CHANGED" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.01' || message.inboundProperties.'coap.response.code' == '2.04' ]" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
        
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_05">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get confirmable="false" config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Get /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
    
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_06">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:delete confirmable="false" config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Delete /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.02']" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >

    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_07">
        <set-payload value="Client request content" doc:name="Set Payload"  />
        <set-property propertyName="coap.opt.content_format" value="0" doc:name="Property"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:put confirmable="false" config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Put /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CREATED or CHANGED" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.01' || message.inboundProperties.'coap.response.code' == '2.04' ]" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
        
     
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_08">
        <set-payload value="Client request content" doc:name="Set Payload"  />
        <set-property propertyName="coap.opt.content_format" value="0" doc:name="Property"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:post confirmable="false" config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Put /test" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CREATED or CHANGED" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.01' || message.inboundProperties.'coap.response.code' == '2.04' ]" doc:name="Validation coap.response.code"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_09_11">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/separate" doc:name="CoAP Get /separate" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_13">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/seg1/seg2/seg3" doc:name="CoAP Get /seg1/seg2/seg3" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_14">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/query" doc:name="CoAP Get /query" host="#[flowVars.host]" port="#[flowVars.port]">
            <coap-client:query-parameters>
                <coap-client:query-parameter>first=1</coap-client:query-parameter>
                <coap-client:query-parameter>second=2</coap-client:query-parameter>
                <coap-client:query-parameter>third=3</coap-client:query-parameter>
            </coap-client:query-parameters>
        </coap-client:get>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>
        
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_17">
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get confirmable="false" config-ref="ETSI-Plugtest_Client" path="/separate" doc:name="CoAP Get /separate" host="#[flowVars.host]" port="#[flowVars.port]" />
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CONTENT" expression="#[message.inboundProperties.'coap.response.code' == '2.05']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response content format is not text/plain" expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>         
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_18">
        <set-payload value="TD_COAP_CORE_18" doc:name="Set Payload" encoding="UTF-8" mimeType="text/plain"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:post  config-ref="ETSI-Plugtest_Client" path="/test" doc:name="CoAP Post /test" host="#[flowVars.host]" port="#[flowVars.port]" />
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CREATED" expression="#[message.inboundProperties.'coap.response.code' == '2.01']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Path option missing" expression="#[message.inboundProperties.'coap.opt.location_path.list' != empty ]" doc:name="Validation coap.opt.location_path exists"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Path option has wrong value" expression="#[((java.util.List)message.inboundProperties.'coap.opt.location_path.list').get(0) == 'location1' ]" doc:name="Validation coap.opt.location_path 0"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Path option has wrong value" expression="#[((java.util.List)message.inboundProperties.'coap.opt.location_path.list').get(1) == 'location2' ]" doc:name="Validation coap.opt.location_path 1"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Path option has wrong value" expression="#[((java.util.List)message.inboundProperties.'coap.opt.location_path.list').get(2) == 'location3' ]" doc:name="Validation coap.opt.location_path 2"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>        
    </sub-flow >

    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_19">
        <set-payload value="TD_COAP_CORE_19" doc:name="Set Payload" encoding="UTF-8" mimeType="text/plain"/>
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:post  config-ref="ETSI-Plugtest_Client" path="/location-query" doc:name="CoAP Post /location-query" host="#[flowVars.host]" port="#[flowVars.port]" />
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP response code is unequal CREATED" expression="#[message.inboundProperties.'coap.response.code' == '2.01']" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Query option missing" expression="#[message.inboundProperties.'coap.opt.location_query.list' != empty ]" doc:name="Validation coap.opt.location_query.list exists"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Query option has wrong value" expression="#[((java.util.List)message.inboundProperties.'coap.opt.location_query.list').get(0) == 'first=1' ]" doc:name="Validation coap.opt.location_query.list 0"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP Location-Query option has wrong value" expression="#[((java.util.List)message.inboundProperties.'coap.opt.location_query.list').get(1) == 'second=2' ]" doc:name="Validation coap.opt.location_query.list 1"/>
        <set-payload value="Test OK:
#[payload]" doc:name="Set Payload"/>        
    </sub-flow >

    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_20">
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <set-property propertyName="coap.opt.accept" value="0" doc:name="set coap.opt.accept"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/multi-format" doc:name="CoAP Get /multi-format" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <set-variable variableName="response1" value="#[payload]" doc:name="save response1"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CONTENT" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.05' ]" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response content_format unequal text/plain" 
        	expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]" doc:name="Validation coap.opt.content_format"/>
        
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <set-property propertyName="coap.opt.accept" value="41" doc:name="set coap.opt.accept"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/multi-format" doc:name="CoAP Get /multi-format" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <set-variable variableName="response2" value="#[payload]" doc:name="save response1"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CONTENT" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.05' ]" doc:name="Validation coap.response.code"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response content_format unequal application/xml" 
        	expression="#[message.inboundProperties.'coap.opt.content_format' == 41 ]" doc:name="Validation coap.opt.content_format"/>
        
        <set-payload value="Test OK:
response 1: #[flowVars.response1] ;
response 2: #[flowVars.response2]  ;" doc:name="Set Payload"/>       
    </sub-flow >
    
    <sub-flow name="coap-client-etsi-plugtest-TD_COAP_CORE_21">
        <flow-ref name="coap-client-etsi-plugtest-set-params" doc:name="coap-client-etsi-plugtest-set-params"/>
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/validate" doc:name="CoAP Get /validate" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <set-variable variableName="response1" value="#[payload]" doc:name="save response1"/>
        <set-variable variableName="etag1" value="#[message.inboundProperties.'coap.opt.etag.list' != empty ? message.inboundProperties.'coap.opt.etag.list'.getFirst() : null ]" doc:name="save etag1"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CONTENT" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.05' ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response should have etag option." 
        	expression="#[ flowVars.etag1 != empty ]" doc:name="Validation coap.opt.etag"/>
        
        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <set-property propertyName="coap.opt.etag.list" value="#[flowVars.etag1]" doc:name="set coap.opt.etag.list"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/validate" doc:name="CoAP Get /validate" host="#[flowVars.host]" port="#[flowVars.port]"/>
       	<logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <set-variable variableName="response2" value="#[payload]" doc:name="save response2"/>
        <set-variable variableName="etag2" value="#[message.inboundProperties.'coap.opt.etag.list' != empty ? message.inboundProperties.'coap.opt.etag.list'.getFirst() : null ]" doc:name="save etag2"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal VALID" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.03' ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" 
        	message="CoAP response should be empty" 
        	 doc:name="Validation empty payload" max="0" min="0" value="#[payload]"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response should have etag option." 
        	expression="#[flowVars.etag2 != empty ]" doc:name="Validation coap.opt.etag"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response etag should be identical." 
        	expression="#[ flowVars.etag2.equals( flowVars.etag1 )]" doc:name="Validation coap.opt.etag"/>

        <set-payload value="#[NullPayload.getInstance()]" doc:name="Set Payload"/>
        <set-property propertyName="coap.opt.etag.list" value="#[flowVars.etag1]" doc:name="set coap.opt.etag.list"/>
        <logger level="INFO" doc:name="Logger"/>
        <coap-client:get config-ref="ETSI-Plugtest_Client" path="/validate" doc:name="CoAP Get /validate" host="#[flowVars.host]" port="#[flowVars.port]"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        <set-variable variableName="response3" value="#[payload]" doc:name="save response3"/>
        <set-variable variableName="etag3" value="#[message.inboundProperties.'coap.opt.etag.list' != empty ? message.inboundProperties.'coap.opt.etag.list'.getFirst() : null ]" doc:name="save etag3"/>
        <validation:is-true config-ref="Validation_Configuration" message="CoAP result is failure" expression="#[message.inboundProperties.'coap.response.success' ]" doc:name="Validation coap.response.success"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response code is unequal CONTENT" 
        	expression="#[message.inboundProperties.'coap.response.code' == '2.05' ]" doc:name="Validation coap.response.code"/>
        <validation:validate-size config-ref="Validation_Configuration" message="CoAP response payload should not be empty" value="#[payload]" min="1" doc:name="Validation payload not empty"/>
        <validation:is-true config-ref="Validation_Configuration" 
        	message="CoAP response should have etag option." 
        	expression="#[flowVars.etag3 != empty ]" doc:name="Validation coap.opt.etag"/>
        <validation:is-false config-ref="Validation_Configuration" 
        	message="CoAP response etag should not be identical." 
        	expression="#[flowVars.etag3.equals( flowVars.etag1 )]" doc:name="Validation coap.opt.etag"/>
        
        <set-payload value="Test OK:   
etag 1: #[flowVars.etag1] ;   
etag 2: #[flowVars.etag2] ;   
etag 3: #[flowVars.etag3] ;   
response 1: #[flowVars.response1] ;  
response 2: #[flowVars.response2] ;  
response 3: #[flowVars.response3] ; " doc:name="Set Payload"/>       
    </sub-flow >
</mule>
