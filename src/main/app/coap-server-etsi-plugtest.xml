<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:coap-client="http://www.mulesoft.org/schema/mule/coap-client" xmlns:coap-server="http://www.mulesoft.org/schema/mule/coap-server" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/coap-server http://www.teslanet.nl/schema/mule/coap-server/1.0/mule-coap-server.xsd
http://www.mulesoft.org/schema/mule/coap-client http://www.teslanet.nl/schema/mule/coap-client/1.0/mule-coap-client.xsd">
    <coap-server:config name="CoAP_ETSI_Plugtest_Server" doc:name="CoAP Server: Server Configuration">
        <coap-server:resources>
            <coap-server:resource name="test" get="true" put="true" delete="true" post="true"/>
            <coap-server:resource name="seg1" get="true">
                <coap-server:resources>
                    <coap-server:resource name="seg2" get="true">
                        <coap-server:resources>
                            <coap-server:resource name="seg3" get="true"/>
                        </coap-server:resources>
                    </coap-server:resource>
                </coap-server:resources>
            </coap-server:resource>
            <coap-server:resource name="location-query" post="true" />
            <coap-server:resource name="query" get="true"/>
            <coap-server:resource name="separate" get="true" earlyAck="true"/>
            <coap-server:resource name="large" get="true" size="2048"/>
            <coap-server:resource name="large_update" get="true" put="true" size="2048"/>
            <coap-server:resource name="large_create" get="true" post="true" size="2048"/>
            <coap-server:resource name="obs" get="true" observe="true"/>
        </coap-server:resources>
    </coap-server:config>
    
    <flow name="coap-server-etsi-plugtest-test">
        <coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/test" doc:name="CoAP ETSI Plugtest listen /test"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'GET']">
                <set-payload value="TD_COAP_CORE_01/05/10 received GET." encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_01 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>

			<when expression="#[ flowVars.method == 'DELETE']">
                <set-payload value="TD_COAP_CORE_02/06 received DELETE" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_02 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>

			<when expression="#[ flowVars.method == 'PUT']">
                <choice doc:name="check content format">
                    <when expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]">
                        <set-payload value="TD_COAP_CORE_03/07 received PUT" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_03 response payload"/>
                        <set-property propertyName="coap.response.code" value="CHANGED" doc:name="CHANGED"/>
                    </when>
                    <otherwise>
                        <set-payload value="Expected text/plain" doc:name="Expected text/plain"/>
                        <set-property propertyName="coap.response.code" value="NOT_ACCEPTABLE" doc:name="NOT_ACCEPTABLE"/>
                    </otherwise>
                </choice>
				
			</when>

			<when expression="#[ flowVars.method == 'POST']">
                <!-- <choice doc:name="check content format">
                    <when expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]">-->
                        <set-payload value="TD_COAP_CORE_04/08/18 received POST" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_04 response payload"/>
                        <set-property propertyName="coap.opt.location_path" value="/location1/location2/location3" doc:name="set Location-Path"/>
                        <set-property propertyName="coap.response.code" value="CREATED" doc:name="CREATED"/>
                <coap-server:add-resource config-ref="CoAP_ETSI_Plugtest_Server" uri="/location1" doc:name="create location1" delete="true" get="true"/>
                <coap-server:add-resource config-ref="CoAP_ETSI_Plugtest_Server" uri="/location1/location2" doc:name="create location2" delete="true" get="true"/>
                <coap-server:add-resource config-ref="CoAP_ETSI_Plugtest_Server" uri="/location1/location2/location3" doc:name="create location3" delete="true" get="true"/>
                    <!--  </when>
                    <otherwise>
                        <set-payload value="Expected text/plain" doc:name="Expected text/plain"/>
                        <set-property propertyName="coap.response.code" value="NOT_ACCEPTABLE" doc:name="NOT_ACCEPTABLE"/>
                    </otherwise>
                </choice>-->
			</when>			
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>
    
    <flow name="coap-server-etsi-plugtest-separate">
        <coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/separate" doc:name="CoAP ETSI Plugtest listen /separate"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'GET']">
                <set-payload value="TD_COAP_CORE_09/11/17 received GET." encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_01 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>

			<when expression="#[ flowVars.method == 'DELETE']">
                <set-payload value="TD_COAP_CORE_02/06 received DELETE" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_02 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>

			<when expression="#[ flowVars.method == 'PUT']">
                <choice doc:name="check content format">
                    <when expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]">
                        <set-payload value="TD_COAP_CORE_03/07 received PUT" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_03 response payload"/>
                        <set-property propertyName="coap.response.code" value="CHANGED" doc:name="CHANGED"/>
                    </when>
                    <otherwise>
                        <set-payload value="Expected text/plain" doc:name="Expected text/plain"/>
                        <set-property propertyName="coap.response.code" value="NOT_ACCEPTABLE" doc:name="NOT_ACCEPTABLE"/>
                    </otherwise>
                </choice>
				
			</when>

			<when expression="#[ flowVars.method == 'POST']">
                <choice doc:name="check content format">
                    <when expression="#[message.inboundProperties.'coap.opt.content_format' == 0 ]">
                        <set-payload value="TD_COAP_CORE_04/08 received POST" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_04 response payload"/>
                        <set-property propertyName="coap.response.code" value="CREATED" doc:name="CREATED"/>
                    </when>
                    <otherwise>
                        <set-payload value="Expected text/plain" doc:name="Expected text/plain"/>
                        <set-property propertyName="coap.response.code" value="NOT_ACCEPTABLE" doc:name="NOT_ACCEPTABLE"/>
                    </otherwise>
                </choice>
			</when>			
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>

    <flow name="coap-server-etsi-plugtest-seg1-3">
        <coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/seg1/seg2/seg3" doc:name="CoAP ETSI Plugtest listen /seg1/seg2/seg3"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'GET']">
                <set-payload value="TD_COAP_CORE_13 received GET." encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_13 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>
    
    <flow name="coap-server-etsi-plugtest-location-query">
        <coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/location-query" doc:name="CoAP ETSI Plugtest listen /location-query"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'POST']">
                <set-payload value="TD_COAP_CORE_19 received POST: #[payload]" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_19 response payload"/>
                <set-property propertyName="coap.opt.location_query" value="first=1&amp;second=2" doc:name="set Location-Query"/>
                <set-property propertyName="coap.response.code" value="CREATED" doc:name="CREATED"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>
    
    <flow name="coap-server-etsi-plugtest-query">
        <coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/query" doc:name="CoAP ETSI Plugtest listen /query"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'GET']">
                <set-payload value="TD_COAP_CORE_14 received GET with query: #[message.inboundProperties.'coap.opt.uri_query']" encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_14 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>
    <!--  TODO : test composite source -->
    <flow name="coap-server-etsi-plugtest-location1-3">
      	<coap-server:listen config-ref="CoAP_ETSI_Plugtest_Server" uri="/location1/*" doc:name="CoAP ETSI Plugtest listen /separate"/>
        <logger level="INFO" doc:name="Logger"/>
        <byte-array-to-string-transformer doc:name="Byte Array to String"/>
        
        <set-variable variableName="method"
			value="#[ message.inboundProperties['coap.request.code']]" doc:name="set method"/>
		<set-variable variableName="uri" value="#[message.inboundProperties['coap.request.uri'] ]"
			doc:name="set uri"/>

		<choice doc:name="Choice request code">
			<when expression="#[ flowVars.method == 'GET']">
                <set-payload value="TD_COAP_CORE_xx received GET." encoding="UTF-8" mimeType="text/plain" doc:name="TD_COAP_CORE_13 response payload"/>
                <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
                <logger level="INFO" doc:name="Logger"/>
				
			</when>
			
			<otherwise>
                <set-payload value="Unexpected request" encoding="UTF-8" mimeType="text/plain" doc:name="Unexpected method"/>
                <set-property propertyName="coap.response.code" value="NOT_IMPLEMENTED" doc:name="NOT_IMPLEMENTED"/>       				
			</otherwise>
		</choice>
        <logger message="#[payload]" level="INFO" doc:name="Log payload"/>
        <logger level="INFO" doc:name="Logger"/>
    </flow>
</mule>
